<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">

  <xacro:macro name="thruster" params="prop_name joint_name parent_link direction mesh_file motor_number xyz rpy mass ixx iyy izz">
    
    <!-- Thruster link -->
    <link name="${prop_name}_link">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="${mesh_file}" scale="1 1 1"/>
        </geometry>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="${mesh_file}" scale="1 1 1"/>
        </geometry>
      </collision>
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <mass value="${mass}"/>
        <inertia ixx="${ixx}" iyy="${iyy}" izz="${izz}" ixy="0" ixz="0" iyz="0"/>
      </inertial>
    </link>

    <!-- Joint connecting to body -->
    <joint name="${joint_name}" type="revolute">
      <origin xyz="${xyz}" rpy="${rpy}"/>
      <parent link="${parent_link}"/>
      <child link="${prop_name}_link"/>
      <axis xyz="0 0 1"/>
      <limit effort="10" velocity="1000"/>
    </joint>

    <!-- Gazebo motor plugin -->
    <gazebo>
      <plugin name="${prop_name}_motor" filename="librotors_gazebo_motor_model.so">
        <robotNamespace>/omnicopter</robotNamespace>
        <jointName>${joint_name}</jointName>
        <linkName>${prop_name}_link</linkName>
        <turningDirection>${direction}</turningDirection>
        <rotorDragCoefficient>0.0001</rotorDragCoefficient>
        <motorConstant>1e-5</motorConstant>
        <momentConstant>0.016</momentConstant>
        <timeConstantUp>0.0125</timeConstantUp>
        <timeConstantDown>0.025</timeConstantDown>
        <commandSubTopic>command/motor_speed</commandSubTopic>
        <motorNumber>${motor_number}</motorNumber>
      </plugin>
    </gazebo>

  </xacro:macro>

<!-- Front Right Prop -->
<xacro:thruster prop_name="prop1" joint_name="prop1_joint" 
                parent_link="base_link"
                direction="cw" mesh_file="package://my_drone/meshes/propeller.dae" 
                motor_number="0"
                xyz="0.2 -0.2 0" rpy="0 0 0"
                mass="0.01" ixx="1e-6" iyy="1e-6" izz="1e-6"/>

<!-- Front Left Prop -->
<xacro:thruster prop_name="prop2" joint_name="prop2_joint" 
                parent_link="base_link"
                direction="ccw" mesh_file="package://my_drone/meshes/propeller.dae" 
                motor_number="1"
                xyz="0.2 0.2 0" rpy="0 0 0"
                mass="0.01" ixx="1e-6" iyy="1e-6" izz="1e-6"/>

</robot>
